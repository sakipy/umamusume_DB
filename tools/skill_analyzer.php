<?php
// ========== „Éö„Éº„Ç∏Ë®≠ÂÆö ==========
$page_title = '„Çπ„Ç≠„É´Áõ∏ÊÄßË®∫Êñ≠';
$current_page = 'skill_analyzer'; // Êñ∞„Åó„ÅÑ„Éö„Éº„Ç∏ID
$base_path = '../';

// ========== „Éá„Éº„Çø„Éô„Éº„ÇπÊé•Á∂ö ==========
$db_host = 'localhost'; $db_user = 'root'; $db_pass = ''; $db_name = 'umamusume_db';
$conn = new mysqli($db_host, $db_user, $db_pass, $db_name);
if ($conn->connect_error) { exit; }
$conn->set_charset("utf8mb4");

// ========== „Éá„Éº„Çø„ÅÆÂèñÂæó ==========
// „Ç¶„ÉûÂ®ò‰∏ÄË¶ß„ÇíÂèñÂæó
$characters_result = $conn->query("SELECT id, character_name FROM characters ORDER BY character_name ASC");
$characters = $characters_result->fetch_all(MYSQLI_ASSOC);

// „Éï„Ç©„Éº„É†„ÅÆÈÅ∏ÊäûËÇ¢„ÇíÂÆöÁæ©
$distance_options = ['Áü≠Ë∑ùÈõ¢', '„Éû„Ç§„É´', '‰∏≠Ë∑ùÈõ¢', 'Èï∑Ë∑ùÈõ¢'];
$strategy_options = ['ÈÄÉ„Åí', 'ÂÖàË°å', 'Â∑Æ„Åó', 'ËøΩËæº'];
$surface_options = ['Ëäù', '„ÉÄ„Éº„Éà'];
$phase_options = ['Â∫èÁõ§', '‰∏≠Áõ§', 'ÁµÇÁõ§', 'ÊúÄÁµÇ„Ç≥„Éº„Éä„Éº', '„É©„Çπ„Éà„Çπ„Éë„Éº„Éà'];
$position_options = ['‰∏ä‰Ωç', '‰∏≠‰Ωç', '‰∏ã‰Ωç'];


// ========== „Éò„ÉÉ„ÉÄ„Éº„ÇíË™≠„ÅøËæº„ÇÄ ==========
include '../templates/header.php';
?>

<style>
.analyzer-form-container {
    background: white;
    border-radius: 12px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    font-weight: 700;
    margin-bottom: 8px;
    color: #4a2e19;
}

.form-group select {
    width: 100%;
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.2s;
}

.form-group select:focus {
    border-color: var(--gold-color, #ffd700);
    outline: none;
}

.form-actions {
    text-align: center;
}

.action-button {
    background: linear-gradient(135deg, #ffd700, #ffed4e);
    color: #4a2e19;
    padding: 15px 40px;
    border: none;
    border-radius: 25px;
    font-weight: 700;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 4px 12px rgba(255,215,0,0.3);
}

.action-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(255,215,0,0.4);
}

#results-container {
    margin-top: 30px;
}

.loading-spinner {
    text-align: center;
    padding: 40px;
    color: #666;
    font-size: 16px;
}

.loading-spinner::before {
    content: "üèá";
    font-size: 2em;
    animation: bounce 1s infinite;
    display: block;
    margin-bottom: 10px;
}

@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

.error-message {
    color: #d32f2f;
    text-align: center;
    padding: 20px;
    background: #ffebee;
    border: 1px solid #ffcdd2;
    border-radius: 8px;
    margin: 20px 0;
}

.error-message h3 {
    margin-top: 0;
    color: #c62828;
}

.error-message p {
    margin: 10px 0;
}

.skill-results-list {
    display: grid;
    gap: 15px;
}

.skill-item {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    transition: transform 0.2s, box-shadow 0.2s;
}

.skill-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
}

.skill-icon-wrapper {
    width: 64px;
    height: 64px;
    margin-right: 20px;
    flex-shrink: 0;
}

.skill-icon {
    width: 100%;
    height: 100%;
    object-fit: contain;
    border-radius: 8px;
}

.skill-icon-placeholder {
    width: 100%;
    height: 100%;
    background: #f0f0f0;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #999;
}

.skill-icon-placeholder::before {
    content: "üéØ";
    font-size: 24px;
}

.skill-details {
    flex: 1;
}

.skill-name {
    font-size: 18px;
    font-weight: 700;
    color: #4a2e19;
    margin-bottom: 8px;
}

.skill-description {
    color: #666;
    margin-bottom: 12px;
    line-height: 1.5;
}

.skill-meta {
    display: flex;
    gap: 10px;
}

.skill-tag {
    background: #e3f2fd;
    color: #1976d2;
    padding: 4px 12px;
    border-radius: 16px;
    font-size: 12px;
    font-weight: 600;
}

.score-badge {
    background: linear-gradient(135deg, #ffd700, #ffed4e);
    color: #4a2e19;
    padding: 4px 12px;
    border-radius: 16px;
    font-size: 12px;
    font-weight: 700;
}

.error-message {
    color: #d32f2f;
    text-align: center;
    padding: 20px;
    background: #ffebee;
    border-radius: 8px;
}
</style>

<div class="container">
    <h1 class="page-title"><?php echo $page_title; ?></h1>

    <div class="analyzer-form-container">
        <form id="skill-analyzer-form" class="analyzer-form">
            <div class="form-grid">
                <div class="form-group">
                    <label for="character_id">„Ç¶„ÉûÂ®ò</label>
                    <select id="character_id" name="character_id">
                        <option value="">ÊåáÂÆö„Åó„Å™„ÅÑ</option>
                        <?php foreach ($characters as $char): ?>
                            <option value="<?php echo $char['id']; ?>"><?php echo htmlspecialchars($char['character_name']); ?></option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <div class="form-group">
                    <label for="distance_type">Ë∑ùÈõ¢</label>
                    <select id="distance_type" name="distance_type">
                        <option value="">„Åô„Åπ„Å¶</option>
                        <?php foreach ($distance_options as $option): ?>
                            <option value="<?php echo $option; ?>"><?php echo $option; ?></option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <div class="form-group">
                    <label for="strategy_type">ËÑöË≥™</label>
                    <select id="strategy_type" name="strategy_type">
                        <option value="">„Åô„Åπ„Å¶</option>
                        <?php foreach ($strategy_options as $option): ?>
                            <option value="<?php echo $option; ?>"><?php echo $option; ?></option>
                        <?php endforeach; ?>
                    </select>
                </div>
                 <div class="form-group">
                    <label for="surface_type">„ÉêÂ†¥</label>
                    <select id="surface_type" name="surface_type">
                        <option value="">„Åô„Åπ„Å¶</option>
                        <?php foreach ($surface_options as $option): ?>
                            <option value="<?php echo $option; ?>"><?php echo $option; ?></option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <div class="form-group">
                    <label for="condition_phase">„É¨„Éº„Çπ„Éï„Çß„Éº„Ç∫</label>
                    <select id="condition_phase" name="condition_phase">
                        <option value="">„Åô„Åπ„Å¶</option>
                        <?php foreach ($phase_options as $option): ?>
                            <option value="<?php echo $option; ?>"><?php echo $option; ?></option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <div class="form-group">
                    <label for="condition_position">È†Ü‰Ωç</label>
                    <select id="condition_position" name="condition_position">
                        <option value="">„Åô„Åπ„Å¶</option>
                        <?php foreach ($position_options as $option): ?>
                            <option value="<?php echo $option; ?>"><?php echo $option; ?></option>
                        <?php endforeach; ?>
                    </select>
                </div>
            </div>
            <div class="form-actions">
                <button type="submit" class="action-button">Ë®∫Êñ≠„Åô„Çã</button>
            </div>
        </form>
    </div>

    <div id="results-container">
        </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('skill-analyzer-form');
    const resultsContainer = document.getElementById('results-container');
    const characterSelect = document.getElementById('character_id');
    const distanceSelect = document.getElementById('distance_type');
    const strategySelect = document.getElementById('strategy_type');

    // „Éï„Ç©„Éº„É†„ÅÆÈÄÅ‰ø°ÔºàÊ§úÁ¥¢ÂÆüË°åÔºâ„ÇíË°å„ÅÜÈñ¢Êï∞
    function performSearch() {
        resultsContainer.innerHTML = '<div class="loading-spinner">Ê§úÁ¥¢‰∏≠...</div>';
        resultsContainer.style.display = 'block';

        const formData = new FormData(form);
        const params = new URLSearchParams(formData).toString();

        console.log('Searching with params:', params);

        fetch('search_skill_affinity.php?' + params, {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            return response.json();
        })
        .then(data => {
            console.log('Data received:', data);
            
            if (data && data.html) {
                resultsContainer.innerHTML = data.html;
            } else {
                throw new Error('Invalid response format');
            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
            resultsContainer.innerHTML = `
                <div class="error-message">
                    <h3>ÁµêÊûú„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</h3>
                    <p>„Ç®„É©„Éº: ${error.message}</p>
                    <p>„Éñ„É©„Ç¶„Ç∂„ÅÆÈñãÁô∫ËÄÖ„ÉÑ„Éº„É´ÔºàF12Ôºâ„Åß„Ç≥„É≥„ÇΩ„Éº„É´„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                </div>
            `;
        });
    }

    // „Éï„Ç©„Éº„É†„ÅåÈÄÅ‰ø°„Åï„Çå„Åü„Å®„Åç„ÅÆ„Ç§„Éô„É≥„Éà
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        performSearch();
    });

    // „Ç¶„ÉûÂ®ò„ÅåÈÅ∏Êäû„Åï„Çå„Åü„Å®„Åç„ÅÆ„Ç§„Éô„É≥„Éà
    characterSelect.addEventListener('change', function() {
        const characterId = this.value;
        if (characterId) {
            console.log('Character selected:', characterId);
            
            // „Ç≠„É£„É©„ÇØ„Çø„Éº„ÅÆË©≥Á¥∞ÊÉÖÂ†±„ÇíAPI„Åã„ÇâÂèñÂæó
            fetch(`get_character_details.php?id=${characterId}`, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                console.log('Character details response:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return response.json();
            })
            .then(data => {
                console.log('Character data received:', data);
                
                if (data.success) {
                    // ÂèñÂæó„Åó„ÅüÊúÄÈÅ©Êù°‰ª∂„Çí„Çª„É¨„ÇØ„Éà„Éú„ÉÉ„ÇØ„Çπ„Å´Ë®≠ÂÆö
                    distanceSelect.value = data.best_distance;
                    strategySelect.value = data.best_strategy;
                    
                    console.log('Set distance:', data.best_distance);
                    console.log('Set strategy:', data.best_strategy);
                    
                    // Ë®≠ÂÆöÂæå„ÄÅËá™ÂãïÁöÑ„Å´Ë®∫Êñ≠„ÇíÂÆüË°å
                    performSearch();
                } else {
                    console.error('Character details error:', data.error);
                }
            })
            .catch(error => {
                console.error('„Ç≠„É£„É©„ÇØ„Çø„ÉºÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó:', error);
                resultsContainer.innerHTML = `
                    <div class="error-message">
                        „Ç≠„É£„É©„ÇØ„Çø„ÉºÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}
                    </div>
                `;
            });
        } else {
            // „Ç¶„ÉûÂ®ò„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØÁµêÊûú„Çí„ÇØ„É™„Ç¢
            resultsContainer.innerHTML = '';
        }
    });
});
</script>

<?php
// ========== „Éï„ÉÉ„Çø„Éº„ÇíË™≠„ÅøËæº„ÇÄ ==========
include '../templates/footer.php';
?>